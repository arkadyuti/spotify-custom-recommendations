# Playlist Management

## Overview

The playlist management feature allows users to save their recommendations directly to Spotify playlists. It supports both creating new playlists and updating existing ones by replacing all tracks.

## Core Functionality

### 1. Create New Playlist
- Generate playlist with custom name
- Add description with timestamp
- Populate with recommended tracks
- Return Spotify URL for access

### 2. Update Existing Playlist
- Parse playlist URL/ID
- Verify user permissions
- Replace all existing tracks
- Maintain playlist metadata

## Implementation Details

### Playlist Creation Flow
```javascript
// POST /api/create-playlist
1. Validate request (name, tracks)
2. Get user profile for ID
3. Create playlist via Spotify API
4. Search and match tracks
5. Add tracks to playlist
6. Return playlist details
```

### Playlist Update Flow
```javascript
// POST /api/update-playlist
1. Extract playlist ID from URL
2. Verify playlist access
3. Search for track URIs
4. Replace playlist contents
5. Return update confirmation
```

## Track Matching Process

### Track Search Strategy
For each recommendation, the system:
1. Constructs precise search query
2. Uses exact match on track + artist
3. Takes first search result
4. Handles search failures gracefully

```javascript
// Search query format
const searchQuery = `track:"${track.name}" artist:"${track.artist}"`;
```

### Batch Processing
- Process up to 50 tracks (Spotify limit)
- 100ms delay between searches (rate limiting)
- Continue on individual failures
- Report success/failure counts

## API Integration

### Spotify Playlist Endpoints

#### Create Playlist
```javascript
api.createPlaylist(userId, name, description, isPublic)
// Returns: playlist object with ID
```

#### Add Tracks
```javascript
api.addTracksToPlaylist(playlistId, trackUris)
// Adds tracks to existing playlist
```

#### Replace Tracks
```javascript
// PUT request to replace all tracks
api.makeRequest(`/playlists/${playlistId}/tracks`, {
  method: 'PUT',
  body: { uris: trackUris }
})
```

### URL Parsing
```javascript
// Supported URL formats:
// https://open.spotify.com/playlist/37i9dQZF1DX5Ejj0EkURtP
// spotify:playlist:37i9dQZF1DX5Ejj0EkURtP
// Returns: playlist ID only
```

## Error Handling

### Common Errors
1. **Invalid Playlist URL**: Malformed or wrong format
2. **Access Denied**: User doesn't own playlist
3. **Track Not Found**: Search returns no results
4. **Rate Limiting**: Too many API calls
5. **Playlist Full**: Exceeds Spotify limits

### Error Recovery
- Continue processing on track failures
- Return partial success information
- Clear error messages to user
- Log detailed errors for debugging

## User Experience

### Playlist Creation UI
```javascript
// Default playlist name
"AI Recommendations • {timestamp}"

// Description template
"Custom recommendations generated by AI • Created {date}"
```

### Success Feedback
```javascript
{
  playlist_name: "My Recommendations",
  tracks_added: 18,
  total_requested: 20,
  external_url: "spotify:playlist:...",
  message: "Successfully added 18 of 20 tracks"
}
```

## Technical Constraints

### Spotify Limitations
- **Playlist Size**: 10,000 tracks maximum
- **Batch Size**: 100 tracks per request
- **Name Length**: 100 characters
- **Description**: 300 characters
- **Public/Private**: User configurable

### Rate Limiting
- Search API: ~180 requests/minute
- Playlist API: ~180 requests/minute
- Implementation: 100ms delays

## Data Flow

### Request Structure
```javascript
// Create Playlist
{
  name: "string",
  tracks: [{
    name: "string",
    artist: "string",
    album: "string",
    ...metadata
  }]
}

// Update Playlist
{
  playlistUrl: "string",
  tracks: [same structure]
}
```

### Response Structure
```javascript
{
  id: "playlist_id",
  name: "Playlist Name",
  external_url: "spotify:playlist:...",
  tracks_added: 20,
  total_requested: 20,
  playlist_id: "for updates"
}
```

## Security Considerations

### Permission Validation
- Verify user owns playlist
- Check OAuth scopes
- Validate playlist ID format
- Prevent injection attacks

### Data Privacy
- No storage of playlist data
- Pass-through architecture
- User-initiated actions only
- No background modifications

## Performance Optimization

### Caching Strategy
- Cache track search results
- Reuse URIs for duplicates
- Batch API operations
- Minimize round trips

### Concurrent Processing
```javascript
// Future optimization
Promise.all(tracks.map(searchTrack))
  .then(filterValidUris)
  .then(batchAddToPlaylist)
```

## User Workflow

### Typical Flow
1. Generate recommendations
2. Review track list
3. Enter/select playlist URL
4. Click "Update Playlist"
5. Receive confirmation
6. Open in Spotify

### Advanced Features (Future)
- Multiple playlist support
- Append vs replace modes
- Playlist templates
- Scheduled updates
- Collaborative playlists

## Migration Recommendations

### Current Limitations
1. Sequential track searching
2. No offline queue
3. Replace-only mode
4. No playlist analytics
5. Limited error recovery

### Suggested Improvements
1. **Batch Search API**: Faster matching
2. **Queue System**: Background processing
3. **Playlist Modes**: Append, shuffle, smart
4. **Analytics**: Track playlist performance
5. **Templates**: Preset playlist types
6. **Scheduling**: Automatic updates
7. **History**: Track changes over time
8. **Collaboration**: Share recommendations

### Architecture Enhancements
1. **Worker Service**: Async playlist updates
2. **Cache Layer**: Track URI mapping
3. **Webhook Integration**: Playlist events
4. **Bulk Operations**: Multiple playlists
5. **Rollback**: Undo capabilities